<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fitting occupancy models with flocker • flocker</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Fitting occupancy models with flocker">
<meta property="og:description" content="flocker">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">flocker</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.2-0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/augmented_models.html">Data-augmented models in flocker</a>
    </li>
    <li>
      <a href="../articles/flocker_format.html">Advanced brms custom families: occupancy models and the `flocker_data` format</a>
    </li>
    <li>
      <a href="../articles/flocker_tutorial.html">Fitting occupancy models with flocker</a>
    </li>
    <li>
      <a href="../articles/multiseason_models.html">Multiseason models in flocker</a>
    </li>
    <li>
      <a href="../articles/nonlinear_models.html">Nonlinear models in flocker</a>
    </li>
    <li>
      <a href="../articles/sbc.html">SBC for flocker models</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/jsocolar/flocker/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Fitting occupancy models with flocker</h1>
                        <h4 data-toc-skip class="author">Jacob Socolar
&amp; Simon Mills</h4>
            
            <h4 data-toc-skip class="date">2023-10-20</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/jsocolar/flocker/blob/HEAD/vignettes/flocker_tutorial.Rmd" class="external-link"><code>vignettes/flocker_tutorial.Rmd</code></a></small>
      <div class="hidden name"><code>flocker_tutorial.Rmd</code></div>

    </div>

    
    
<p><img align="right" src="../reference/figures/flocker_sticker.png" width="30%" style="border:none;"></p>
<p><code>flocker</code> is an R package for fitting <a href="https://jsocolar.github.io/closureOccupancy/" class="external-link">occupancy models</a>
that incorportate sophisticated effects structures using simple
formula-based syntax. <code>flocker</code> is built on R package
<code>brms</code>, which in turn is a front-end for
<code>Stan</code>.</p>
<p>This vignette is intended as a companion to <a href="https://www.biorxiv.org/content/10.1101/2023.10.26.564080v1" class="external-link">Socolar
&amp; Mills 2023</a>, where we provide details of the models and
post-processing functionality available in <code>flocker</code> in
greater detail. Here, we provide illustrative R code for several types
of model, demonstrating data simulation, model fitting, and model
post-processing. We also showcase the <code>brms</code> syntax that
<code>flocker</code> can use to fit a variety of sophisticated effect
structures.</p>
<div class="section level2">
<h2 id="terms-and-definitions">Terms and definitions<a class="anchor" aria-label="anchor" href="#terms-and-definitions"></a>
</h2>
<p>Socolar &amp; Mills (2023) introduce several terms that figure
importantly in this vignette, including:</p>
<ul>
<li><p><strong>closure-unit</strong>: The groupings of observations over
which <a href="https://jsocolar.github.io/closureOccupancy/" class="external-link">closure</a>
is assumed. In single-species models, a closure-unit corresponds to a
“site” or “point”. In multi-species models, a closure-unit is a
species-site combination. In dynamic (multi-season) models, a
closure-unit is a site-season combination (or species-site-season in a
multi-species dynamic model).</p></li>
<li><p><strong>rep-constant</strong>, <strong>rep-varying</strong>: We
refer to models that assume constant detection probabilities across
repeat visits within closure-units as <em>rep-constant models</em>, as
contrasted with <em>rep-varying models</em> that incorporate
event-specific detection covariates. It turns out that rep-constant
models enable a more efficient parametrization of the likelihood than
rep-varying models.</p></li>
<li><p><strong>unit covariates</strong>, <strong>event
covariates</strong>: We refer to any covariate that does not vary across
sampling events within closure-units as a “unit covariate”. This
includes covariates that are intrinsically properties of single
closure-units (e.g. the elevations of sites in a single-species model),
covariates that are intrinsically properties of groups of closure units
(e.g.  elevations of sites in a multi-species model), and covariates
that are intrinsically properties of sampling events but happen to be
constant within all closure-units (e.g. observer in a sampling design
where every site is visited by exactly one observer). We refer to any
covariate that varies across sampling events within covariates as an
“event covariate”. Note that while unit covariates may appear in either
the occupancy or the detection formula, event covariates are restricted
to the detection formula. Models that incorporate event covariates are
<em>rep-varying</em> (see above); those that do not are
<em>rep-constant</em>.</p></li>
</ul>
</div>
<div class="section level2">
<h2 id="installation-and-feedback">Installation and feedback<a class="anchor" aria-label="anchor" href="#installation-and-feedback"></a>
</h2>
<p><a href="https://jsocolar.github.io/flocker" class="external-link">Installation
instructions are available here</a>. To request features or report bugs
(much appreciated!), please <a href="https://github.com/jsocolar/flocker/issues" class="external-link">open an issue on
GitHub</a>.</p>
<p>To make <code>flocker</code> and <code>brms</code> functions globally
available within an R session run:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jsocolar/flocker" class="external-link">flocker</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/paul-buerkner/brms" class="external-link">brms</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="data-simulation">Data simulation<a class="anchor" aria-label="anchor" href="#data-simulation"></a>
</h2>
<p>General purpose data simulation is provided via
<code><a href="../reference/simulate_flocker_data.html">simulate_flocker_data()</a></code>, which by default will simulate a
dataset with 30 species sampled at 50 sites using four replicate surveys
(i.e. a single-season multi-species dataset). Non-default arguments will
simulate example data for other likelihoods, including multi-season and
data-augmented occupancy models.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate_flocker_data.html">simulate_flocker_data</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>The simulated data <code>d</code> are in list form, with elements for
the detection/non-detection observations <code>d$obs</code>, unit
covariates <code>d$unit_covs</code>, and event covariates
<code>d$event_covs</code>. <code>d$obs</code> is a matrix where rows are
species-site combinations, columns are replicate visits, and entries are
<code>1</code> (detection), <code>0</code> (nondetection), or
<code>NA</code> (no visit). <code>d$unit_covs</code> is a dataframe
containing covariates that vary across the rows of obs (i.e. by
closure-unit) but not across the columns within any given row (i.e. do
not vary across replicate visits). <code>event_covs</code> is a named
list of matrices, with each matrix having the same dimensions as the
observation matrix. Each list element corresponds to a covariate that
varies across the columns of <code>d$obs</code> (i.e.  varies between
replicate visits).</p>
</div>
<div class="section level2">
<h2 id="data-formatting">Data formatting<a class="anchor" aria-label="anchor" href="#data-formatting"></a>
</h2>
<p><code><a href="../reference/flock.html">flock()</a></code>, the main function in <code>flocker</code> for
fitting occupancy models, expects a highly specific data format that we
<a href="https://jsocolar.github.io/flocker/articles/flocker_format.html" class="external-link">describe
more fully here</a>. The function <code><a href="../reference/make_flocker_data.html">make_flocker_data()</a></code>
formats data for use with <code><a href="../reference/flock.html">flock()</a></code> automatically. For
single-season models, <code><a href="../reference/make_flocker_data.html">make_flocker_data()</a></code> takes as input a
matrix or dataframe of detection/non-detection data. Rows represent
closure-units, columns represent repeated sampling events within
closure-units, and entries must be <code>0</code> (nondetection),
<code>1</code> (detection), or <code>NA</code> (no corresponding
sampling event). The data must be formatted so that all <code>NA</code>s
are trailing within their rows. For example, if some units were sampled
four times and other three times, the three sampling events must be
treated as events 1, 2, and 3 (with the fourth event <code>NA</code>)
rather than as events 1, 3, and 4 (with the second event
<code>NA</code>) or any other combination.</p>
<p>Many occupancy models also include covariates that influence
occupancy or detection probabilities. Unit covariates (see <a href="#terms-and-definitions">Terms and definitions</a>) can be passed
to <code><a href="../reference/make_flocker_data.html">make_flocker_data()</a></code> as a dataframe with the same number
of rows as the observation matrix and data in the same order as the rows
of the observation matrix. Columns are covariates, and we recommend
using informative column names. <em>Event covariates</em> (see <a href="#terms-and-definitions">Terms and definitions</a>) can be passed
as a named list of matrices whose elements <code>[i, j]</code> are the
covariate values for the sampling event represented by the corresponding
position of the observation matrix. Again, we recommend using
informative names for the list elements. If the corresponding
observation is <code>NA</code>, then the value of the event covariate
does not matter.</p>
<p>To pass data to <code>flocker</code>, we first pass the output from
<code><a href="../reference/simulate_flocker_data.html">simulate_flocker_data()</a></code> to
<code><a href="../reference/make_flocker_data.html">make_flocker_data()</a></code>, which will repackage data and apply
the necessary formatting:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fd_rep_varying</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_flocker_data.html">make_flocker_data</a></span><span class="op">(</span></span>
<span>  obs <span class="op">=</span> <span class="va">d</span><span class="op">$</span><span class="va">obs</span>, </span>
<span>  unit_covs <span class="op">=</span> <span class="va">d</span><span class="op">$</span><span class="va">unit_covs</span>, </span>
<span>  event_covs <span class="op">=</span> <span class="va">d</span><span class="op">$</span><span class="va">event_covs</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; Formatting data for a single-season occupancy model. For details, see make_flocker_data_static. All warnings and error messages should be interpreted in the context of make_flocker_data_static</span></span></code></pre></div>
<p>The function <code><a href="../reference/make_flocker_data.html">make_flocker_data()</a></code> outputs an object of
class <code>flocker_data</code> that we can pass to flocker’s model
fitting function <code><a href="../reference/flock.html">flock()</a></code>. Note that this is the general
workflow users will need to follow with real data. Alternative inputs to
<code><a href="../reference/make_flocker_data.html">make_flocker_data()</a></code> and <code><a href="../reference/flock.html">flock()</a></code> enable the
user to readily fit multi-season models as well as multi-species models
with data augmentation (see below).</p>
</div>
<div class="section level2">
<h2 id="model-fitting">Model fitting<a class="anchor" aria-label="anchor" href="#model-fitting"></a>
</h2>
<div class="section level3">
<h3 id="the-single-season-rep-varying-model">The single-season rep-varying model<a class="anchor" aria-label="anchor" href="#the-single-season-rep-varying-model"></a>
</h3>
<p>To fit a model, in this case a single-season multi-species occupancy
model, we use the function <code><a href="../reference/flock.html">flock()</a></code>. By supplying different
arguments to this function, all flavors of occupancy model available in
<code>flocker</code> can be fitted. Formulas for the different
distributional parameters in the model (occupancy, detection,
colonization, extinction, and autologistic terms as applicable) are
provided as one-sided formulas to the relevant arguments of
<code><a href="../reference/flock.html">flock()</a></code> (<code>f_occ</code>, <code>f_det</code>,
<code>f_col</code>, <code>f_ex</code>, and <code>f_auto</code> as
applicable).</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rep_varying</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flock.html">flock</a></span><span class="op">(</span></span>
<span>  f_occ <span class="op">=</span> <span class="op">~</span> <span class="va">uc1</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">uc1</span> <span class="op">|</span> <span class="va">species</span><span class="op">)</span>,</span>
<span>  f_det <span class="op">=</span> <span class="op">~</span> <span class="va">uc1</span> <span class="op">+</span> <span class="va">ec1</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">uc1</span> <span class="op">+</span> <span class="va">ec1</span> <span class="op">|</span> <span class="va">species</span><span class="op">)</span>,</span>
<span>  flocker_data <span class="op">=</span> <span class="va">fd_rep_varying</span>,</span>
<span>  cores <span class="op">=</span> <span class="fl">4</span>,</span>
<span>  silent <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  refresh <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>Arguments supplied to <code><a href="../reference/flock.html">flock()</a></code> define formulas using
<code>brms</code> syntax for the occupancy (<code>f_occ</code>) and
detection (<code>f_det</code>) components, and also provide the
formatted data. At this stage, the full flexibility and power of
<code>brms</code> formula syntax are available to the user (see
following sections for some examples). <code>rep_varying</code> is a
<code>brmsfit</code> object from package <code>brms</code> and also a
<code>flockerfit</code> object from package <code>flocker</code>.
Post-processing functions from <code>brms</code> will typically not work
with this object and are instead replaced by <code>flocker</code>
equivalents.</p>
</div>
<div class="section level3">
<h3 id="the-single-season-rep-constant-model">The single-season rep-constant model<a class="anchor" aria-label="anchor" href="#the-single-season-rep-constant-model"></a>
</h3>
<p><code><a href="../reference/make_flocker_data.html">make_flocker_data()</a></code> will automatically format the data
for a rep-constant model when <code>event_covs = NULL</code> and the
desired model is a single-season model without data augmentation. To
take advantage of the efficiency gains and post-processing functionality
of the rep-constant model, it is necessary to supply
<code>event_covs = NULL</code> to <code><a href="../reference/make_flocker_data.html">make_flocker_data()</a></code> at
the moment of data formatting; it is insufficient to omit event
covariates from the detection formula supplied to <code><a href="../reference/flock.html">flock()</a></code>
after formatting the data for a rep-varying model.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fd_rep_constant</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_flocker_data.html">make_flocker_data</a></span><span class="op">(</span></span>
<span>  obs <span class="op">=</span> <span class="va">d</span><span class="op">$</span><span class="va">obs</span>, </span>
<span>  unit_covs <span class="op">=</span> <span class="va">d</span><span class="op">$</span><span class="va">unit_covs</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; Formatting data for a single-season occupancy model. For details, see make_flocker_data_static. All warnings and error messages should be interpreted in the context of make_flocker_data_static</span></span>
<span><span class="va">rep_constant</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flock.html">flock</a></span><span class="op">(</span></span>
<span>  f_occ <span class="op">=</span> <span class="op">~</span> <span class="va">uc1</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">uc1</span> <span class="op">|</span> <span class="va">species</span><span class="op">)</span>,</span>
<span>  f_det <span class="op">=</span> <span class="op">~</span> <span class="va">uc1</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">uc1</span> <span class="op">|</span> <span class="va">species</span><span class="op">)</span>,</span>
<span>  flocker_data <span class="op">=</span> <span class="va">fd_rep_constant</span>,</span>
<span>  save_pars <span class="op">=</span> <span class="fu"><a href="https://paul-buerkner.github.io/brms/reference/save_pars.html" class="external-link">save_pars</a></span><span class="op">(</span>all <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="co"># for loo with moment matching</span></span>
<span>  silent <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  refresh <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  cores <span class="op">=</span> <span class="fl">4</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>Note that within-chain parallelization is available (uniquely so) for
the rep-constant mode:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rep_constant</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flock.html">flock</a></span><span class="op">(</span></span>
<span>  f_occ <span class="op">=</span> <span class="op">~</span> <span class="va">uc1</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">uc1</span> <span class="op">|</span> <span class="va">species</span><span class="op">)</span>,</span>
<span>  f_det <span class="op">=</span> <span class="op">~</span> <span class="va">uc1</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">uc1</span> <span class="op">|</span> <span class="va">species</span><span class="op">)</span>,</span>
<span>  flocker_data <span class="op">=</span> <span class="va">fd_rep_constant</span>,</span>
<span>  silent <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  refresh <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  chains <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  cores <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  threads <span class="op">=</span> <span class="fl">2</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="multi-season-models">Multi-season models<a class="anchor" aria-label="anchor" href="#multi-season-models"></a>
</h3>
<p>Here we provide code examples to complement the <a href="https://www.biorxiv.org/content/10.1101/2023.10.26.564080v1" class="external-link">companion
publication</a>. For a more complete vignette on multi-season models in
<code>flocker</code>, see the <a href="https://jsocolar.github.io/flocker/articles/multiseason_models.html" class="external-link">multiseason
models vignette</a>.</p>
<p>First, we simulate some data that are valid for use with multi-season
models. Here, we will simulate data for three seasons with one unit
covariate and one event covariate. The data will be simulated under a
colonization-extinction model with explicit inits, but we will be able
to fit other models (autologistic, equilibrium inits) to the same data
(note that <code><a href="../reference/simulate_flocker_data.html">simulate_flocker_data()</a></code> can also simulate
directly from these other model types).</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">multi_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate_flocker_data.html">simulate_flocker_data</a></span><span class="op">(</span></span>
<span>  n_season <span class="op">=</span> <span class="fl">3</span>,</span>
<span>  n_pt <span class="op">=</span> <span class="fl">300</span>,</span>
<span>  n_sp <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  multiseason <span class="op">=</span> <span class="st">"colex"</span>, </span>
<span>  multi_init <span class="op">=</span> <span class="st">"explicit"</span>,</span>
<span>  seed <span class="op">=</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">fd_multi</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_flocker_data.html">make_flocker_data</a></span><span class="op">(</span></span>
<span>  <span class="va">multi_data</span><span class="op">$</span><span class="va">obs</span>, </span>
<span>  <span class="va">multi_data</span><span class="op">$</span><span class="va">unit_covs</span>, </span>
<span>  <span class="va">multi_data</span><span class="op">$</span><span class="va">event_covs</span>, </span>
<span>  type <span class="op">=</span> <span class="st">"multi"</span>,</span>
<span>  quiet <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>Below, we fit the colonization-extinction model with an explicit
model for occupancy in the first timestep. Depending on hardware,
fitting this model might take several minutes.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">multi_colex</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flock.html">flock</a></span><span class="op">(</span></span>
<span>  f_occ <span class="op">=</span> <span class="op">~</span> <span class="va">uc1</span>,</span>
<span>  f_det <span class="op">=</span> <span class="op">~</span> <span class="va">uc1</span> <span class="op">+</span> <span class="va">ec1</span>,</span>
<span>  f_col <span class="op">=</span> <span class="op">~</span> <span class="va">uc1</span>,</span>
<span>  f_ex <span class="op">=</span> <span class="op">~</span> <span class="va">uc1</span>,</span>
<span>  flocker_data <span class="op">=</span> <span class="va">fd_multi</span>,</span>
<span>  multiseason <span class="op">=</span> <span class="st">"colex"</span>,</span>
<span>  multi_init <span class="op">=</span> <span class="st">"explicit"</span>,</span>
<span>  cores <span class="op">=</span> <span class="fl">4</span>,</span>
<span>  silent <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  refresh <span class="op">=</span> <span class="fl">0</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Here is the colonization-extinction model using equilibrium occupancy
probabilities in the first timestep:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">multi_colex_eq</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flock.html">flock</a></span><span class="op">(</span></span>
<span>  f_det <span class="op">=</span> <span class="op">~</span> <span class="va">uc1</span> <span class="op">+</span> <span class="va">ec1</span>,</span>
<span>  f_col <span class="op">=</span> <span class="op">~</span> <span class="va">uc1</span>,</span>
<span>  f_ex <span class="op">=</span> <span class="op">~</span> <span class="va">uc1</span>,</span>
<span>  flocker_data <span class="op">=</span> <span class="va">fd_multi</span>,</span>
<span>  multiseason <span class="op">=</span> <span class="st">"colex"</span>,</span>
<span>  multi_init <span class="op">=</span> <span class="st">"equilibrium"</span>,</span>
<span>  cores <span class="op">=</span> <span class="fl">4</span>,</span>
<span>  silent <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  refresh <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>Here is the autologistic model with explicit occupancy probabilities
in the first timestep. To reflect the stereotypical autologistic model
with a constant logit-scale offset separating colonization and
persistence probabilities, we use the formula <code>f_auto = ~ 1</code>,
but it is fine to relax this constraint and use,
e.g. <code>f_auto = ~ uc1</code>.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">multi_auto</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flock.html">flock</a></span><span class="op">(</span></span>
<span>  f_occ <span class="op">=</span> <span class="op">~</span> <span class="va">uc1</span>,</span>
<span>  f_det <span class="op">=</span> <span class="op">~</span> <span class="va">uc1</span> <span class="op">+</span> <span class="va">ec1</span>,</span>
<span>  f_col <span class="op">=</span> <span class="op">~</span> <span class="va">uc1</span>,</span>
<span>  f_auto <span class="op">=</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>  flocker_data <span class="op">=</span> <span class="va">fd_multi</span>,</span>
<span>  multiseason <span class="op">=</span> <span class="st">"autologistic"</span>,</span>
<span>  multi_init <span class="op">=</span> <span class="st">"explicit"</span>,</span>
<span>  cores <span class="op">=</span> <span class="fl">4</span>,</span>
<span>  silent <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  refresh <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>And the autologistic model with equilibrium occupancy probabilities
in the first timestep:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">multi_auto_eq</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flock.html">flock</a></span><span class="op">(</span></span>
<span>  f_det <span class="op">=</span> <span class="op">~</span> <span class="va">uc1</span> <span class="op">+</span> <span class="va">ec1</span>,</span>
<span>  f_col <span class="op">=</span> <span class="op">~</span> <span class="va">uc1</span>,</span>
<span>  f_auto <span class="op">=</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>  flocker_data <span class="op">=</span> <span class="va">fd_multi</span>,</span>
<span>  multiseason <span class="op">=</span> <span class="st">"autologistic"</span>,</span>
<span>  multi_init <span class="op">=</span> <span class="st">"equilibrium"</span>,</span>
<span>  cores <span class="op">=</span> <span class="fl">4</span>,</span>
<span>  silent <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  refresh <span class="op">=</span> <span class="fl">0</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="data-augmented-multi-species-models">Data-augmented multi-species models<a class="anchor" aria-label="anchor" href="#data-augmented-multi-species-models"></a>
</h3>
<p>Here we provide a simple example of code for a data augmented model.
For a more complete unified vignette on data-augmented models in
<code>flocker</code>, see the <a href="https://jsocolar.github.io/flocker/articles/augmented_models.html" class="external-link">data-augmented
models vignette</a>.</p>
<p>Fitting the data-augmented model in <code>flocker</code> requires
passing the observed data as a three-dimensional array with sites along
the first dimension, visits along the second, and species along the
third. Additionally, we must supply the <code>n_aug</code> argument to
<code><a href="../reference/make_flocker_data.html">make_flocker_data()</a></code>, specifying how many all-zero
pseudospecies to augment the data with.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">augmented_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate_flocker_data.html">simulate_flocker_data</a></span><span class="op">(</span></span>
<span>    augmented <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">)</span></span>
<span><span class="va">fd_augmented</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_flocker_data.html">make_flocker_data</a></span><span class="op">(</span></span>
<span>  <span class="va">augmented_data</span><span class="op">$</span><span class="va">obs</span>, <span class="va">augmented_data</span><span class="op">$</span><span class="va">unit_covs</span>, <span class="va">augmented_data</span><span class="op">$</span><span class="va">event_covs</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"augmented"</span>, n_aug <span class="op">=</span> <span class="fl">100</span>,</span>
<span>  quiet <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">augmented</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flock.html">flock</a></span><span class="op">(</span></span>
<span>  f_occ <span class="op">=</span> <span class="op">~</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">ff_species</span><span class="op">)</span>,</span>
<span>  f_det <span class="op">=</span> <span class="op">~</span> <span class="va">uc1</span> <span class="op">+</span> <span class="va">ec1</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">uc1</span> <span class="op">+</span> <span class="va">ec1</span> <span class="op">|</span> <span class="va">ff_species</span><span class="op">)</span>,</span>
<span>  augmented <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  flocker_data <span class="op">=</span> <span class="va">fd_augmented</span>,</span>
<span>  cores <span class="op">=</span> <span class="fl">4</span>,</span>
<span>  silent <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  refresh <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#bulk-ess</span></span></code></pre></div>
<p>Here, the random effect of species is specified using the special
grouping keyword <code>ff_species</code> (names beginning with
<code>ff_</code> are reserved in <code>flocker</code> and are not
allowed as names for user-supplied covariates).</p>
</div>
</div>
<div class="section level2">
<h2 id="post-processing">Post-processing<a class="anchor" aria-label="anchor" href="#post-processing"></a>
</h2>
<p><code>flocker</code> provides functions for four main types of
bespoke post-processing for occupancy models.
<code><a href="../reference/fitted_flocker.html">fitted_flocker()</a></code> computes (and optionally summarizes)
posterior distributions of fitted values at the locations of the data
used in model fitting or of new data. <code><a href="../reference/get_Z.html">get_Z()</a></code> provides the
posterior distribution for the latent occupancy state.
<code><a href="../reference/predict_flocker.html">predict_flocker()</a></code> provides posterior predictions at the
observed points (e.g. for use in posterior predictive checking) or for
new data. <code><a href="../reference/loo_flocker.html">loo_flocker()</a></code> and
<code><a href="../reference/loo_compare_flocker.html">loo_compare_flocker()</a></code> both provide functionality for model
comparison. See below for details on all four types of post-processing.
Both posterior predictions and model comparison rely on subtle aspects
of the occupancy model likelihood that we explain in more detail <a href="https://jsocolar.github.io/likelihoodOccupancy/" class="external-link">here</a>.</p>
<div class="section level3">
<h3 id="brms-native-post-processing">brms-native post-processing<a class="anchor" aria-label="anchor" href="#brms-native-post-processing"></a>
</h3>
<p>All post-processing functions from <code>brms</code> work on
single-season rep-constant models, but do not work on any other model
types. For example:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">predictions_rep_constant</span> <span class="op">&lt;-</span> <span class="fu">brms</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstantools/reference/posterior_predict.html" class="external-link">posterior_predict</a></span><span class="op">(</span><span class="va">rep_constant</span><span class="op">)</span></span>
<span><span class="va">loo_rep_constant</span> <span class="op">&lt;-</span> <span class="fu">brms</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/loo/reference/loo.html" class="external-link">loo</a></span><span class="op">(</span><span class="va">rep_constant</span>, moment_match <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu">brms</span><span class="fu">::</span><span class="fu"><a href="https://paul-buerkner.github.io/brms/reference/conditional_effects.brmsfit.html" class="external-link">conditional_effects</a></span><span class="op">(</span><span class="va">rep_constant</span><span class="op">)</span></span></code></pre></div>
<p>The following functions work on all model types available in
<code>flocker</code>.</p>
</div>
<div class="section level3">
<h3 id="fitted-values">Fitted values<a class="anchor" aria-label="anchor" href="#fitted-values"></a>
</h3>
<p>Fitted values for any of the distributional parameter (one or more of
occupancy, detection, colonization, extinction, autologistic, and/or
Omega, the fitted probability that a given (pseudo)species occurs in the
metacommunity) are available via <code>fitted_flocker</code>. For
example:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/fitted_flocker.html">fitted_flocker</a></span><span class="op">(</span><span class="va">rep_constant</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/fitted_flocker.html">fitted_flocker</a></span><span class="op">(</span><span class="va">rep_varying</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/fitted_flocker.html">fitted_flocker</a></span><span class="op">(</span><span class="va">multi_colex</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/fitted_flocker.html">fitted_flocker</a></span><span class="op">(</span><span class="va">augmented</span><span class="op">)</span></span></code></pre></div>
<p><code>fitted_flocker</code> provides a replacement for
<code><a href="https://mc-stan.org/rstantools/reference/posterior_linpred.html" class="external-link">brms::posterior_linpred()</a></code>. While the
<code>brms</code>-native function executes on any <code>flocker</code>
model, it returns in an opaque shape related to <a href="https://jsocolar.github.io/flocker/articles/flocker_format.html" class="external-link">the
flocker data format</a>. <code><a href="../reference/fitted_flocker.html">fitted_flocker()</a></code> returns in the
shape of the observations passed to <code><a href="../reference/make_flocker_data.html">make_flocker_data()</a></code>,
with posterior iterations stacked along its final dimension.</p>
</div>
<div class="section level3">
<h3 id="the-posterior-occupancy-state">The posterior occupancy state<a class="anchor" aria-label="anchor" href="#the-posterior-occupancy-state"></a>
</h3>
<p>The function <code><a href="../reference/get_Z.html">get_Z()</a></code> returns the posterior distribution
of occupancy probabilities across the closure-units. The shape of the
output depends on the class of model, and is an array in the shape of
the first visit in <code>obs</code> as passed to
<code>make_flocker_data</code>, with posterior iterations stacked along
the final dimension. Thus, for a single-season rep-varying model, the
output is a matrix where rows are posterior iterations, columns are
closure-units, and values are draws from the posterior distribution of
occupancy probabilities:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/get_Z.html">get_Z</a></span><span class="op">(</span><span class="va">rep_varying</span><span class="op">)</span></span></code></pre></div>
<p>For all model types, <code><a href="../reference/get_Z.html">get_Z()</a></code> accepts an optional
<code>new_data</code> argument. Leaving the default
<code>new_data = NULL</code> supplies the posterior for the true
occupancy state at the locations of the data used to fit the model.
Otherwise, the posterior is computed over the new data. For
single-season models, <code>new_data</code> can be supplied as a
dataframe of unit covariate values or as a <code>flocker_data</code>
object. For multi-season models, only a <code>flocker_data</code> object
is allowed. Note that if predictions are desired at sites without
observations, it is acceptable to pass an array of dummy observations
(e.g. all zeros) to <code><a href="../reference/make_flocker_data.html">make_flocker_data()</a></code> and then to set
<code>history_condition = FALSE</code> in the call to
<code><a href="../reference/get_Z.html">get_Z()</a></code>.</p>
<p><code><a href="../reference/get_Z.html">get_Z()</a></code> accepts several additional arguments that
control the way that posterior is obtained and the values returned. See
the <a href="https://www.biorxiv.org/content/10.1101/2023.10.26.564080v1" class="external-link">companion
paper</a> and <code><a href="../reference/get_Z.html">?get_Z</a></code> for details.</p>
</div>
<div class="section level3">
<h3 id="posterior-prediction">Posterior prediction<a class="anchor" aria-label="anchor" href="#posterior-prediction"></a>
</h3>
<p>The function <code><a href="../reference/predict_flocker.html">predict_flocker()</a></code> provides posterior
predictions. By default, predictions are provided for the covariate data
to which the model were fit, but predictions to new data are also
possible via the <code>new_data</code> argument. The output differs by
model type. For single-season rep-constant models, the return is a
matrix where rows are iterations, columns are units, and values are the
number of detections. For single-season rep-varying models, the return
is an array whose first dimension is units, second dimension is sampling
events, third dimension is iterations, and values are <code>1</code>,
<code>0</code>, or <code>NA</code>, representing detection,
nondetection, and no corresponding sampling event. For example:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/predict_flocker.html">predict_flocker</a></span><span class="op">(</span><span class="va">rep_varying</span><span class="op">)</span></span></code></pre></div>
<p><code><a href="../reference/predict_flocker.html">predict_flocker()</a></code> accepts several additional arguments
that control the way that posterior is obtained and the values of
returned. See the <a href="https://www.biorxiv.org/content/10.1101/2023.10.26.564080v1" class="external-link">companion
paper</a> and <code><a href="../reference/predict_flocker.html">?predict_flocker</a></code> for details.</p>
</div>
<div class="section level3">
<h3 id="model-comparison">Model comparison<a class="anchor" aria-label="anchor" href="#model-comparison"></a>
</h3>
<p>The most straightforward way to compare models fit with
<code>flocker</code> is the function <code><a href="../reference/loo_compare_flocker.html">loo_compare_flocker()</a></code>.
This function takes a list of flocker_fit objects as its argument and
returns a model comparison table based on the difference in the expected
log predictive density (elpd) between models. This table is a
<code>compare.loo</code> object from <code><a href="https://mc-stan.org/loo/reference/loo_compare.html" class="external-link">loo::loo_compare()</a></code>.
The “leave-one-out” holdouts consist of entire closure-units
(single-season models), series (multi-season models), or species
(augmented models), not single sampling events (see the <a href="https://www.biorxiv.org/content/10.1101/2023.10.26.564080v1" class="external-link">companion
paper</a> and <a href="https://jsocolar.github.io/likelihoodOccupancy/" class="external-link">here</a> for
details of why).</p>
<p><code><a href="../reference/loo_compare_flocker.html">loo_compare_flocker()</a></code> accepts as input a list of
<code>flockerfit</code> objects and outputs a model comparison table.
For example, we can compare the rep-constant and rep-varying models that
we fit to the same initial data. Recall that the data were simulated
with event-covariate effects on detection, and as expected the
rep-varying model performs best. Note that we ensure that these
comparisons between rep-constant and rep-varying models are valid by
omitting the binomial coefficient when computing the log-likelihood for
the rep-constant model.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/loo_compare_flocker.html">loo_compare_flocker</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">rep_constant</span>, <span class="va">rep_varying</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Some Pareto k diagnostic values are too high. See help('pareto-k-diagnostic') for details.</span></span>
<span></span>
<span><span class="co">#&gt; Warning: Some Pareto k diagnostic values are too high. See help('pareto-k-diagnostic') for details.</span></span>
<span><span class="co">#&gt;        elpd_diff se_diff</span></span>
<span><span class="co">#&gt; model2    0.0       0.0 </span></span>
<span><span class="co">#&gt; model1 -171.1      17.2</span></span></code></pre></div>
<p>Likewise, we can compare the four flavors of multi-season model that
we fit above. Recall that the data were simulated under
colonization-extinction dynamics (rather than autologistic) and under
explicit initial occupancy probabilities (rather than equilibrium). As
expected, the <code>multi_colex</code> model performs best:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/loo_compare_flocker.html">loo_compare_flocker</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">multi_colex</span>, <span class="va">multi_colex_eq</span>, <span class="va">multi_auto</span>, <span class="va">multi_auto_eq</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;        elpd_diff se_diff</span></span>
<span><span class="co">#&gt; model1   0.0       0.0  </span></span>
<span><span class="co">#&gt; model3  -7.8       4.1  </span></span>
<span><span class="co">#&gt; model2 -27.1       7.2  </span></span>
<span><span class="co">#&gt; model4 -32.9       7.9</span></span></code></pre></div>
<p>Flocker also provides the function <code><a href="../reference/loo_flocker.html">loo_flocker()</a></code> to
return a table of <code>elpd_loo</code>, <code>p_loo</code>, and
<code>looic</code> estimates from <code><a href="https://mc-stan.org/loo/reference/loo.html" class="external-link">loo::loo()</a></code> or
<code><a href="https://mc-stan.org/loo/reference/loo.html" class="external-link">brms::loo()</a></code> (the latter for single-season rep-constant
models only).</p>
</div>
</div>
<div class="section level2">
<h2 id="brms-tips-and-tricks">
<code>brms</code> tips and tricks<a class="anchor" aria-label="anchor" href="#brms-tips-and-tricks"></a>
</h2>
<p>Mastering advanced occupancy modeling via <code>flocker</code> is
mostly a matter of mastering the syntax available in <code>brms</code>.
Here are some useful pieces of syntax:</p>
<div class="section level3">
<h3 id="priors">Priors<a class="anchor" aria-label="anchor" href="#priors"></a>
</h3>
<p>Priors can be implemented as they would with any <code>brms</code>
model. Priors can be specified using <code><a href="https://paul-buerkner.github.io/brms/reference/set_prior.html" class="external-link">set_prior()</a></code>, with
priors specified for groups of parameters (via <code>class</code>) or
individual parameters (via <code>coef</code>). The priors used for a
particular model can be retrieved using
<code><a href="https://mc-stan.org/rstantools/reference/prior_summary.html" class="external-link">brms::prior_summary()</a></code>, and the names of the parameters and
their default priors can be displayed prior to model fitting using
<code><a href="../reference/get_flocker_prior.html">get_flocker_prior()</a></code> which is a drop-in replacement for
<code><a href="https://paul-buerkner.github.io/brms/reference/get_prior.html" class="external-link">brms::get_prior()</a></code>.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/get_flocker_prior.html">get_flocker_prior</a></span><span class="op">(</span></span>
<span>  f_occ <span class="op">=</span> <span class="op">~</span> <span class="va">uc1</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">uc1</span> <span class="op">|</span> <span class="va">species</span><span class="op">)</span>,</span>
<span>  f_det <span class="op">=</span> <span class="op">~</span> <span class="va">uc1</span> <span class="op">+</span> <span class="va">ec1</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">uc1</span> <span class="op">+</span> <span class="va">ec1</span> <span class="op">|</span> <span class="va">species</span><span class="op">)</span>,</span>
<span>  flocker_data <span class="op">=</span> <span class="va">fd_rep_varying</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt;                 prior     class      coef   group resp dpar nlpar lb ub       source</span></span>
<span><span class="co">#&gt;                (flat)         b                                              default</span></span>
<span><span class="co">#&gt;                (flat)         b       ec1                               (vectorized)</span></span>
<span><span class="co">#&gt;                (flat)         b       uc1                               (vectorized)</span></span>
<span><span class="co">#&gt;                lkj(1)       cor                                              default</span></span>
<span><span class="co">#&gt;                lkj(1)       cor           species                       (vectorized)</span></span>
<span><span class="co">#&gt;  student_t(3, 0, 2.5) Intercept                                              default</span></span>
<span><span class="co">#&gt;  student_t(3, 0, 2.5)        sd                                    0         default</span></span>
<span><span class="co">#&gt;  student_t(3, 0, 2.5)        sd           species                  0    (vectorized)</span></span>
<span><span class="co">#&gt;  student_t(3, 0, 2.5)        sd       ec1 species                  0    (vectorized)</span></span>
<span><span class="co">#&gt;  student_t(3, 0, 2.5)        sd Intercept species                  0    (vectorized)</span></span>
<span><span class="co">#&gt;  student_t(3, 0, 2.5)        sd       uc1 species                  0    (vectorized)</span></span>
<span><span class="co">#&gt;                (flat)         b                         occ                  default</span></span>
<span><span class="co">#&gt;                (flat)         b       uc1               occ             (vectorized)</span></span>
<span><span class="co">#&gt;                (flat) Intercept                         occ                  default</span></span>
<span><span class="co">#&gt;  student_t(3, 0, 2.5)        sd                         occ        0         default</span></span>
<span><span class="co">#&gt;  student_t(3, 0, 2.5)        sd           species       occ        0    (vectorized)</span></span>
<span><span class="co">#&gt;  student_t(3, 0, 2.5)        sd Intercept species       occ        0    (vectorized)</span></span>
<span><span class="co">#&gt;  student_t(3, 0, 2.5)        sd       uc1 species       occ        0    (vectorized)</span></span>
<span><span class="fu">brms</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstantools/reference/prior_summary.html" class="external-link">prior_summary</a></span><span class="op">(</span><span class="va">rep_varying</span><span class="op">)</span></span>
<span><span class="co">#&gt;                 prior     class      coef   group resp dpar nlpar lb ub       source</span></span>
<span><span class="co">#&gt;                (flat)         b                                              default</span></span>
<span><span class="co">#&gt;                (flat)         b       ec1                               (vectorized)</span></span>
<span><span class="co">#&gt;                (flat)         b       uc1                               (vectorized)</span></span>
<span><span class="co">#&gt;                (flat)         b                         occ                  default</span></span>
<span><span class="co">#&gt;                (flat)         b       uc1               occ             (vectorized)</span></span>
<span><span class="co">#&gt;  student_t(3, 0, 2.5) Intercept                                              default</span></span>
<span><span class="co">#&gt;                (flat) Intercept                         occ                  default</span></span>
<span><span class="co">#&gt;  lkj_corr_cholesky(1)         L                                              default</span></span>
<span><span class="co">#&gt;  lkj_corr_cholesky(1)         L           species                       (vectorized)</span></span>
<span><span class="co">#&gt;  student_t(3, 0, 2.5)        sd                                    0         default</span></span>
<span><span class="co">#&gt;  student_t(3, 0, 2.5)        sd                         occ        0         default</span></span>
<span><span class="co">#&gt;  student_t(3, 0, 2.5)        sd           species                  0    (vectorized)</span></span>
<span><span class="co">#&gt;  student_t(3, 0, 2.5)        sd       ec1 species                  0    (vectorized)</span></span>
<span><span class="co">#&gt;  student_t(3, 0, 2.5)        sd Intercept species                  0    (vectorized)</span></span>
<span><span class="co">#&gt;  student_t(3, 0, 2.5)        sd       uc1 species                  0    (vectorized)</span></span>
<span><span class="co">#&gt;  student_t(3, 0, 2.5)        sd           species       occ        0    (vectorized)</span></span>
<span><span class="co">#&gt;  student_t(3, 0, 2.5)        sd Intercept species       occ        0    (vectorized)</span></span>
<span><span class="co">#&gt;  student_t(3, 0, 2.5)        sd       uc1 species       occ        0    (vectorized)</span></span></code></pre></div>
<p>Note that in examples like the above, with covariates shared between
both the occupancy and detection model formulas (<code>uc1</code> in
this example), then the prior table will contain two entries associated
with the covariate, one for the parameter governing occupancy and one
for the parameter governing detection. Specifying priors for parameters
in formulas other than detection can be done with reference to the
<code>dpar</code> column, e.g.:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">user_prior</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu">brms</span><span class="fu">::</span><span class="fu"><a href="https://paul-buerkner.github.io/brms/reference/set_prior.html" class="external-link">set_prior</a></span><span class="op">(</span><span class="st">"normal(0, 1)"</span>, coef <span class="op">=</span> <span class="st">"uc1"</span><span class="op">)</span>, </span>
<span>                <span class="fu">brms</span><span class="fu">::</span><span class="fu"><a href="https://paul-buerkner.github.io/brms/reference/set_prior.html" class="external-link">set_prior</a></span><span class="op">(</span><span class="st">"normal(0, 3)"</span>, coef <span class="op">=</span> <span class="st">"uc1"</span>, dpar <span class="op">=</span> <span class="st">"occ"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>where the <code>uc1</code> parameter in the occupancy component is
specified by the addition of the <code>dpar</code> argument, and the
<code>uc1</code> parameter in the detection component is specified
without reference to <code>dpar</code>.</p>
<p>For more on priors in <code>brms</code>, see
<code><a href="https://paul-buerkner.github.io/brms/reference/set_prior.html" class="external-link">?brms::set_prior</a></code>.</p>
<p>Users should understand the implications of the default
<code>brms</code> behavior to internally center the design matrix, which
affects how the prior on the intercept gets set (see
<code><a href="https://paul-buerkner.github.io/brms/reference/set_prior.html" class="external-link">?brms::set_prior</a></code>). Here is an example, based on a
single-season rep-varying model, wherein we set a logistic prior on the
value of the intercepts (flat on the probability scale) when all
predictors are held at their means and a moderately regularizing prior
on the coefficients:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rep_varying_prior1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flock.html">flock</a></span><span class="op">(</span></span>
<span>  f_occ <span class="op">=</span> <span class="op">~</span> <span class="va">uc1</span>,</span>
<span>  f_det <span class="op">=</span> <span class="op">~</span> <span class="va">ec1</span>,</span>
<span>  flocker_data <span class="op">=</span> <span class="va">fd_rep_varying</span>,</span>
<span>  prior <span class="op">=</span> </span>
<span>    <span class="fu">brms</span><span class="fu">::</span><span class="fu"><a href="https://paul-buerkner.github.io/brms/reference/set_prior.html" class="external-link">set_prior</a></span><span class="op">(</span><span class="st">"logistic(0,1)"</span>, class <span class="op">=</span> <span class="st">"Intercept"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">brms</span><span class="fu">::</span><span class="fu"><a href="https://paul-buerkner.github.io/brms/reference/set_prior.html" class="external-link">set_prior</a></span><span class="op">(</span><span class="st">"logistic(0,1)"</span>, class <span class="op">=</span> <span class="st">"Intercept"</span>, dpar <span class="op">=</span> <span class="st">"occ"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">brms</span><span class="fu">::</span><span class="fu"><a href="https://paul-buerkner.github.io/brms/reference/set_prior.html" class="external-link">set_prior</a></span><span class="op">(</span><span class="st">"normal(0,2)"</span>, class <span class="op">=</span> <span class="st">"b"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">brms</span><span class="fu">::</span><span class="fu"><a href="https://paul-buerkner.github.io/brms/reference/set_prior.html" class="external-link">set_prior</a></span><span class="op">(</span><span class="st">"normal(0,2)"</span>, class <span class="op">=</span> <span class="st">"b"</span>, dpar <span class="op">=</span> <span class="st">"occ"</span><span class="op">)</span>,</span>
<span>  cores <span class="op">=</span> <span class="fl">4</span>,</span>
<span>  silent <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  refresh <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">)</span></span>
<span><span class="fu">brms</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstantools/reference/prior_summary.html" class="external-link">prior_summary</a></span><span class="op">(</span><span class="va">rep_varying_prior1</span><span class="op">)</span></span>
<span><span class="co">#&gt;          prior     class coef group resp dpar nlpar lb ub       source</span></span>
<span><span class="co">#&gt;    normal(0,2)         b                                          user</span></span>
<span><span class="co">#&gt;    normal(0,2)         b  ec1                             (vectorized)</span></span>
<span><span class="co">#&gt;    normal(0,2)         b                  occ                     user</span></span>
<span><span class="co">#&gt;    normal(0,2)         b  uc1             occ             (vectorized)</span></span>
<span><span class="co">#&gt;  logistic(0,1) Intercept                                          user</span></span>
<span><span class="co">#&gt;  logistic(0,1) Intercept                  occ                     user</span></span></code></pre></div>
<p>Here is an example where we set informative priors on the intercepts
when all covariates are fixed to zero and the same moderately
regularizing prior on the coefficients:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rep_varying_prior2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flock.html">flock</a></span><span class="op">(</span></span>
<span>  f_occ <span class="op">=</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">Intercept</span> <span class="op">+</span> <span class="va">uc1</span>,</span>
<span>  f_det <span class="op">=</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">Intercept</span> <span class="op">+</span> <span class="va">ec1</span>,</span>
<span>  flocker_data <span class="op">=</span> <span class="va">fd_rep_varying</span>,</span>
<span>  prior <span class="op">=</span> </span>
<span>    <span class="fu">brms</span><span class="fu">::</span><span class="fu"><a href="https://paul-buerkner.github.io/brms/reference/set_prior.html" class="external-link">set_prior</a></span><span class="op">(</span><span class="st">"normal(0,2)"</span>, class <span class="op">=</span> <span class="st">"b"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">brms</span><span class="fu">::</span><span class="fu"><a href="https://paul-buerkner.github.io/brms/reference/set_prior.html" class="external-link">set_prior</a></span><span class="op">(</span><span class="st">"normal(0,2)"</span>, class <span class="op">=</span> <span class="st">"b"</span>, dpar <span class="op">=</span> <span class="st">"occ"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">brms</span><span class="fu">::</span><span class="fu"><a href="https://paul-buerkner.github.io/brms/reference/set_prior.html" class="external-link">set_prior</a></span><span class="op">(</span><span class="st">"normal(1, 1)"</span>, class <span class="op">=</span> <span class="st">"b"</span>, coef <span class="op">=</span> <span class="st">"Intercept"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">brms</span><span class="fu">::</span><span class="fu"><a href="https://paul-buerkner.github.io/brms/reference/set_prior.html" class="external-link">set_prior</a></span><span class="op">(</span><span class="st">"normal(-1, 1)"</span>, class <span class="op">=</span> <span class="st">"b"</span>, coef <span class="op">=</span> <span class="st">"Intercept"</span>, dpar <span class="op">=</span> <span class="st">"occ"</span><span class="op">)</span>,</span>
<span>  cores <span class="op">=</span> <span class="fl">4</span>,</span>
<span>  silent <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  refresh <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">)</span></span>
<span><span class="fu">brms</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstantools/reference/prior_summary.html" class="external-link">prior_summary</a></span><span class="op">(</span><span class="va">rep_varying_prior2</span><span class="op">)</span></span>
<span><span class="co">#&gt;          prior class      coef group resp dpar nlpar lb ub       source</span></span>
<span><span class="co">#&gt;    normal(0,2)     b                                               user</span></span>
<span><span class="co">#&gt;    normal(0,2)     b       ec1                             (vectorized)</span></span>
<span><span class="co">#&gt;   normal(1, 1)     b Intercept                                     user</span></span>
<span><span class="co">#&gt;    normal(0,2)     b                       occ                     user</span></span>
<span><span class="co">#&gt;  normal(-1, 1)     b Intercept             occ                     user</span></span>
<span><span class="co">#&gt;    normal(0,2)     b       uc1             occ             (vectorized)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="model-formulas">Model formulas<a class="anchor" aria-label="anchor" href="#model-formulas"></a>
</h3>
<p>Simple formulas follow the same syntax as R’s <code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm()</a></code>
function. For example:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flock.html">flock</a></span><span class="op">(</span></span>
<span>  f_occ <span class="op">=</span> <span class="op">~</span> <span class="va">uc1</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">species</span><span class="op">)</span>, </span>
<span>  f_det <span class="op">=</span> <span class="op">~</span> <span class="fl">1</span>, </span>
<span>  flocker_data <span class="op">=</span> <span class="va">fd_rep_constant</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="random-effects">Random effects<a class="anchor" aria-label="anchor" href="#random-effects"></a>
</h3>
<p>Simple random effects follow <code>lme4</code> syntax, including
advanced <code>lme4</code> syntax like <code>||</code> for uncorrelated
effects and <code>/</code> and <code>:</code> for expansion of multiple
grouping terms. Here’s a simple example:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flock.html">flock</a></span><span class="op">(</span></span>
<span>  f_occ <span class="op">=</span> <span class="op">~</span> <span class="va">uc1</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">species</span><span class="op">)</span>, </span>
<span>  f_det <span class="op">=</span> <span class="op">~</span> <span class="fl">1</span>, </span>
<span>  flocker_data <span class="op">=</span> <span class="va">fd_rep_constant</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>When a model includes multiple random effects with the same grouping
term, by default they are modeled as correlated <em>within</em> the
occupancy or detection formulas, but as uncorrelated <em>between</em>
formulas. For example, the code below estimates a single correlation for
the intercept and slope in the occupancy sub-model.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flock.html">flock</a></span><span class="op">(</span></span>
<span>  f_occ <span class="op">=</span> <span class="op">~</span> <span class="va">uc1</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">uc1</span> <span class="op">|</span> <span class="va">species</span><span class="op">)</span>, </span>
<span>  f_det <span class="op">=</span> <span class="op">~</span> <span class="va">ec1</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">species</span><span class="op">)</span>, </span>
<span>  flocker_data <span class="op">=</span> <span class="va">fd_rep_varying</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>However, this assumption can easily be relaxed using the
<code>|&lt;ID&gt;|</code> syntax from <code>brms</code>. The
<code>&lt;ID&gt;</code> is an arbitrary character string representing a
group of terms to model as correlated. The below code, for example,
models correlated intercepts in the occupancy and detection sub-models,
and correlated effects of <code>sc1</code> on occupancy and
<code>vc1</code> on detection, but no correlations between the
intercepts and the slopes in either sub-model:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod4</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flock.html">flock</a></span><span class="op">(</span></span>
<span>  f_occ <span class="op">=</span> <span class="op">~</span> <span class="va">uc1</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span><span class="va">g1</span><span class="op">|</span> <span class="va">species</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">0</span> <span class="op">+</span> <span class="va">uc1</span> <span class="op">|</span><span class="va">g2</span><span class="op">|</span> <span class="va">species</span><span class="op">)</span>, </span>
<span>  f_det <span class="op">=</span> <span class="op">~</span> <span class="va">ec1</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span><span class="va">g1</span><span class="op">|</span> <span class="va">species</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">0</span> <span class="op">+</span> <span class="va">ec1</span> <span class="op">|</span><span class="va">g2</span><span class="op">|</span> <span class="va">species</span><span class="op">)</span>, </span>
<span>  flocker_data <span class="op">=</span> <span class="va">fd_rep_varying</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>For more on <code>brms</code> syntax for random effects syntax, see
the <a href="https://cran.r-project.org/web/packages/brms/vignettes/brms_multilevel.pdf" class="external-link">documentation
here</a>.</p>
</div>
<div class="section level3">
<h3 id="nonlinear-models">Nonlinear models<a class="anchor" aria-label="anchor" href="#nonlinear-models"></a>
</h3>
<p>Via <code>brms</code>, <code>flocker</code> supports Gaussian
processes of arbitrary dimensionality (<code><a href="https://paul-buerkner.github.io/brms/reference/gp.html" class="external-link">brms::gp()</a></code>) as well
as <code>mgcv</code> syntax for thin-plate regression splines
(<code><a href="https://paul-buerkner.github.io/brms/reference/s.html" class="external-link">brms::s()</a></code>) and tensor product smooths
(<code><a href="https://paul-buerkner.github.io/brms/reference/s.html" class="external-link">brms::t2()</a></code>), and <code>brms</code> syntax for monotonic
effects of ordinal factors via <code><a href="https://paul-buerkner.github.io/brms/reference/mo.html" class="external-link">brms::mo()</a></code> (<a href="https://paul-buerkner.github.io/brms/articles/brms_monotonic.html" class="external-link">see
here</a>). For example:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod5</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flock.html">flock</a></span><span class="op">(</span></span>
<span>  f_occ <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://paul-buerkner.github.io/brms/reference/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">uc1</span><span class="op">)</span>, </span>
<span>  f_det <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://paul-buerkner.github.io/brms/reference/s.html" class="external-link">t2</a></span><span class="op">(</span><span class="va">uc1</span>, <span class="va">ec1</span><span class="op">)</span>, </span>
<span>  flocker_data <span class="op">=</span> <span class="va">fd_rep_varying</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">mod6</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flock.html">flock</a></span><span class="op">(</span></span>
<span>  f_occ <span class="op">=</span> <span class="op">~</span> <span class="fl">1</span>, </span>
<span>  f_det <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://paul-buerkner.github.io/brms/reference/gp.html" class="external-link">gp</a></span><span class="op">(</span><span class="va">uc1</span>, <span class="va">ec1</span><span class="op">)</span>, </span>
<span>  flocker_data <span class="op">=</span> <span class="va">fd_rep_varying</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>In addition, <code>brms</code> provides the ability to estimate
models wherein the predictors (e.g. for occupancy and detection) are
parametric nonlinear functions whose parameters have their own
covariate-based linear predictors. For more details and an example, see
the <a href="https://jsocolar.github.io/flocker/articles/nonlinear_models.html" class="external-link">nonlinear
models vignette</a>.</p>
</div>
<div class="section level3">
<h3 id="phylogenetic-models">Phylogenetic models<a class="anchor" aria-label="anchor" href="#phylogenetic-models"></a>
</h3>
<p>Phylogenetic effects can be included by providing a covariance matrix
as a <code>data2</code> argument and using the <code><a href="https://paul-buerkner.github.io/brms/reference/gr.html" class="external-link">brms::gr()</a></code>
function to link species identities in <code>flocker_data</code> with
the supplied covariance matrix. Note that phylogenetic effects can be
included in either the occupancy component, the detection component, or
both! In our experience, it can be computationally tractable to include
multiple phylogenetic effects within a single occupancy model (see <a href="https://doi.org/10.1002/ecy.3867" class="external-link">Mills et al. 2022</a>).</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># simulate an example phylogeny</span></span>
<span><span class="va">phylogeny</span> <span class="op">&lt;-</span> <span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/rtree.html" class="external-link">rtree</a></span><span class="op">(</span><span class="fl">30</span>, tip.label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"sp_"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># calculate covariance matrix</span></span>
<span><span class="va">A</span> <span class="op">&lt;-</span> <span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/vcv.phylo.html" class="external-link">vcv.phylo</a></span><span class="op">(</span><span class="va">phylogeny</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mod8</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flock.html">flock</a></span><span class="op">(</span></span>
<span>  f_occ <span class="op">=</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="fu"><a href="https://paul-buerkner.github.io/brms/reference/gr.html" class="external-link">gr</a></span><span class="op">(</span><span class="va">species</span>, cov <span class="op">=</span> <span class="va">A</span><span class="op">)</span><span class="op">)</span>, </span>
<span>  f_det <span class="op">=</span> <span class="op">~</span>  <span class="fl">1</span> <span class="op">+</span> <span class="va">ec1</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">species</span><span class="op">)</span>, </span>
<span>  flocker_data <span class="op">=</span> <span class="va">fd_rep_varying</span>, </span>
<span>  data2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>A <span class="op">=</span> <span class="va">A</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">mod9</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flock.html">flock</a></span><span class="op">(</span></span>
<span>  f_occ <span class="op">=</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="fu"><a href="https://paul-buerkner.github.io/brms/reference/gr.html" class="external-link">gr</a></span><span class="op">(</span><span class="va">species</span>, cov <span class="op">=</span> <span class="va">A</span><span class="op">)</span><span class="op">)</span>, </span>
<span>  f_det <span class="op">=</span> <span class="op">~</span>  <span class="fl">1</span> <span class="op">+</span> <span class="va">ec1</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="fu"><a href="https://paul-buerkner.github.io/brms/reference/gr.html" class="external-link">gr</a></span><span class="op">(</span><span class="va">species</span>, cov <span class="op">=</span> <span class="va">A</span><span class="op">)</span><span class="op">)</span>, </span>
<span>  flocker_data <span class="op">=</span> <span class="va">fd_rep_varying</span>, </span>
<span>  data2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>A <span class="op">=</span> <span class="va">A</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><a href="https://paul-buerkner.github.io/brms/articles/brms_phylogenetics.html" class="external-link">See
here</a> for further details about specifying phylogenetic effects in
<code>brms</code>.</p>
</div>
<div class="section level3">
<h3 id="spatial-and-autoregressive-structures">Spatial and autoregressive structures<a class="anchor" aria-label="anchor" href="#spatial-and-autoregressive-structures"></a>
</h3>
<p>In addition to spatial Gaussian processes, <code>brms</code> provides
a variety of autoregressive structures, both one-dimensional (see
<code>brms::ar()</code>, <code><a href="https://paul-buerkner.github.io/brms/reference/arma.html" class="external-link">brms::arma()</a></code>) and two-dimensional
(see <code><a href="https://paul-buerkner.github.io/brms/reference/car.html" class="external-link">brms::car()</a></code>, <code><a href="https://paul-buerkner.github.io/brms/reference/sar.html" class="external-link">brms::sar()</a></code>. <a href="https://paul-buerkner.github.io/brms/reference/car.html" class="external-link">See
here</a> for details about conditional autoregressive (CAR) models in
<code>brms</code>, and note that <code><a href="../reference/flock.html">flock()</a></code> accepts a
<code>data2</code> argument that it can pass to <code>brms</code> as
necessary.</p>
<p>Our principle caution for users is that these autoregressive
structures might lead to degenerate models when applied at the visit
level (in detection formulas) or at the closure-unit level (in
occupancy, colonization, extinction, or autologistic formulas) because
observation-level random effects are often degenerate in regressions
with Bernoulli responses. Thus we recommend applying autoregressive
terms to groupings of multiple visits (detection formula) or multiple
closure-units (other formulas). However, we note that
<code>flocker</code> <em>does</em> provide a well-identified
one-dimensional first-order autoregressive structure for occupancy
across closure-units in a single-season model. This is achieved by
co-opting the autologistic parameterization of the multi-season model
and applying it instead to closure-units arranged along a
one-dimensional spatial transect, yielding a one-dimensional analog of a
spatial autologistic occupancy model.</p>
<p>A second caution is to remind users that in multi-species models,
users will likely want to fit separate spatial terms by species (<a href="https://besjournals.onlinelibrary.wiley.com/doi/full/10.1111/2041-210X.13897" class="external-link">Doser
et al 2022</a>). For Gaussian processes, this can be achieved via the
<code>by</code> argument to <code><a href="https://paul-buerkner.github.io/brms/reference/gp.html" class="external-link">brms::gp()</a></code>. For some
conditional autoregressive structures (those that allow disconnected
islands), this can be achieved by passing a block-diagonal adjacency
matrix wherein species are disconnected components.</p>
<p>We note that gaussian process priors for spatially varying
coefficients are readily achieved via the nonlinear formula syntax of
<code>brms</code>, though they may require large volumes of data to
successfully fit. For more details and an example, see the <a href="https://jsocolar.github.io/flocker/articles/nonlinear_models.html" class="external-link">nonlinear
models vignette</a>.</p>
</div>
<div class="section level3">
<h3 id="measurement-error-in-covariates">Measurement error in covariates<a class="anchor" aria-label="anchor" href="#measurement-error-in-covariates"></a>
</h3>
<p><a href="http://paul-buerkner.github.io/brms/reference/me.html" class="external-link">See
here</a> for relevant <code>brms</code> documentation.</p>
</div>
</div>
<div class="section level2">
<h2 id="additional-fitting-arguments">Additional fitting arguments<a class="anchor" aria-label="anchor" href="#additional-fitting-arguments"></a>
</h2>
<p><code>flock</code> will pass any relevant parameters forward to
<code><a href="https://paul-buerkner.github.io/brms/reference/brm.html" class="external-link">brms::brm()</a></code>, giving the user important control over the
algorithmic details of how the model is fit. See <code><a href="https://paul-buerkner.github.io/brms/reference/brm.html" class="external-link">?brms::brm</a></code>
for details. To speed up the execution, we recommend supplying the
argument <code>backend = "cmdstanr"</code>. This requires the
<code>cmdstanr</code> package and a working installation of
<code>cmdstan</code>; <a href="https://mc-stan.org/cmdstanr/" class="external-link">see
here</a> for instructions to get started and further details.</p>
<center>
<p><img src="../reference/figures/logo2.png" style="border:none;;width:30.0%"></p>
</center>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Jacob B. Socolar, Simon C. Mills.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
